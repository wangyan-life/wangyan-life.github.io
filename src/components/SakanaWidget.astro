---
// 定义组件 Props，提供灵活的配置选项
interface Props {
  // 缩放比例（0.3-0.6 适合博客场景）
  scale?: number;
  // 角色选择：takina 或 chisato
  character?: 'takina' | 'chisato';
  // 是否允许点击切换角色
  canSwitchCharacter?: boolean;
  // 定位方式：fixed 固定或 absolute 绝对定位
  position?: 'fixed' | 'absolute';
  // 水平位置：left、center、right
  horizontal?: 'left' | 'center' | 'right';
  // 垂直位置：top、middle、bottom
  vertical?: 'top' | 'middle' | 'bottom';
  // 额外的 CSS 类名
  className?: string;
}

// 解构 Props 并设置合理的默认值
const {
  scale = 0.4,  // 默认 0.4 大小比较适中
  character = 'takina',
  canSwitchCharacter = true,
  position = 'fixed',
  horizontal = 'right',
  vertical = 'bottom',
  className = '',
} = Astro.props;

// 计算位置样式，支持响应式定位
const positionStyles = {
  left: horizontal === 'left' ? '20px' : horizontal === 'center' ? '50%' : 'auto',
  right: horizontal === 'right' ? '20px' : 'auto',
  top: vertical === 'top' ? '20px' : vertical === 'middle' ? '50%' : 'auto',
  bottom: vertical === 'bottom' ? '20px' : 'auto',
  transform: horizontal === 'center' && vertical === 'middle' 
    ? 'translate(-50%, -50%)' 
    : horizontal === 'center' 
      ? 'translateX(-50%)' 
      : vertical === 'middle' 
        ? 'translateY(-50%)' 
        : 'none',
};
---

<!-- 
  Sakana 容器
  - data-sakana="true" 用于脚本识别容器
  - 通过 data-* 属性传递配置参数
  - 使用内联样式设置定位
-->
<div 
  class:list={['sakana-widget', className]} 
  data-sakana="true"
  data-scale={scale}
  data-character={character}
  data-can-switch={canSwitchCharacter}
  style={`
    position: ${position};
    left: ${positionStyles.left};
    right: ${positionStyles.right};
    top: ${positionStyles.top};
    bottom: ${positionStyles.bottom};
    transform: ${positionStyles.transform};
    z-index: 1000;
  `}
></div>

<!-- 
  1. 通过 CDN 加载 Sakana 库
  - is:inline 告诉 Astro 不要打包这个脚本
  - async 属性异步加载，不阻塞页面渲染
  - crossorigin="anonymous" 处理跨域问题
-->
<script 
  src="https://cdn.jsdelivr.net/npm/sakana" 
  is:inline
  async
  crossorigin="anonymous"
>
</script>

<!-- 
  2. 初始化脚本
  - is:inline 直接内联到 HTML
  - 使用 DOMContentLoaded 确保 DOM 就绪
  - 轮询检查 Sakana 是否加载完成
  - 支持多个组件实例
-->
<script is:inline>
  // 等待 Sakana 加载完成
  document.addEventListener('DOMContentLoaded', function() {
    // 轮询检查函数
    function checkAndInit() {
      // 如果 Sakana 未定义，100ms 后重试
      if (typeof Sakana === 'undefined') {
        setTimeout(checkAndInit, 100);
        return;
      }
      
      // 查找所有 Sakana 容器
      const containers = document.querySelectorAll('[data-sakana="true"]');
      
      // 遍历初始化每个实例
      containers.forEach(container => {
        // 从 data-* 属性读取配置
        const scale = parseFloat(container.dataset.scale || '0.4');
        const character = container.dataset.character || 'takina';
        const canSwitchCharacter = container.dataset.canSwitch !== 'false';
        
        // 初始化 Sakana
        Sakana.init({
          el: container,
          scale,
          character,
          canSwitchCharacter,
        });
      });
    }
    
    // 开始轮询检查
    checkAndInit();
  });
</script>

<!-- 
  3. 组件样式
  - :global() 确保样式应用到子元素
  - 添加悬停效果提升交互体验
-->
<style>
  .sakana-widget {
    cursor: pointer;
    filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.2));
    transition: transform 0.3s ease;
  }
  
  .sakana-widget:hover {
    transform: translateY(-5px);
  }
</style>